<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head', { title: title }) %>
  </head>
  <body>
    <div class="container">
      <header class="dashboard-header">
        <h1>My Reading List</h1>
        <div class="actions">
          <button id="show-new-category-form" class="btn">
            + New Category
          </button>
          <a href="/books/new" class="btn btn-primary">+ New Book</a>
        </div>
      </header>

      <div id="form-error-container">
        <button id="close-error" class="btn-close" aria-label="Close form">
          &times;
        </button>
      </div>
      <%- include('../partials/category_quick_form') %>

      <main class="kanban-board">
        <% categories.forEach((category) => { %> <% const booksInCategory =
        books.filter((b) => b.category_id === category.id); %>
        <section class="kanban-column">
          <header class="kanban-head">
            <h3><%= category.name %></h3>
            <span class="count"><%= booksInCategory.length %></span>
          </header>

          <div class="kanban-cards">
            <% if (booksInCategory.length) { %> <%
            booksInCategory.forEach((book) => { %>
            <a href="/books/<%= book.id %>" class="book-card-link">
              <div class="book-card">
                <img
                  src="<%= book.cover_image_url || '/placeholder.png' %>"
                  alt="Cover of <%= book.title %>"
                  loading="lazy"
                />
                <div>
                  <h4 class="title"><%= book.title %></h4>
                  <p class="author"><%= book.author %></p>
                  <div class="chips">
                    <% if (book.rating !== null) { %>
                    <span class="chip rating-chip"
                      >â˜… <%= book.rating %>/10</span
                    >
                    <% } %> <% if (book.genre) { %> <%
                    book.genre.split(',').forEach((g) => { %>
                    <span class="chip"><%= g.trim() %></span>
                    <% }) %> <% } %>
                  </div>
                </div>
              </div>
            </a>
            <% }) %> <% } else { %>
            <p class="no-books">No books here yet.</p>
            <% } %>
          </div>

          <footer class="kanban-foot">
            <a href="/categories/<%= category.id %>" class="btn">View all</a>
          </footer>
        </section>
        <% }) %>
      </main>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const formWrapper = document.getElementById('category-form-wrapper');
        const showButton = document.getElementById('show-new-category-form');
        const cancelButton = document.getElementById('cancel-category-form');
        const nameInput = document.getElementById('category-name');
        const descInput = document.getElementById('category-description');
        const errorContainer = document.getElementById('form-error-container');

        const showForm = () => formWrapper.classList.remove('hidden');
        const hideForm = () => formWrapper.classList.add('hidden');

        showButton.addEventListener('click', showForm);
        cancelButton.addEventListener('click', hideForm);

        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        if (error) {
          const errorList = document.createElement('ul');
          errorList.className = 'error-list';
          error.split(';').forEach((msg) => {
            const li = document.createElement('li');
            li.textContent = msg.trim();
            errorList.appendChild(li);
          });
          errorContainer.appendChild(errorList);
          // showForm();
        }
      });
      document.addEventListener('DOMContentLoaded', () => {
        const cancelDelete = document.getElementById('cancel-delete');
        const errorContainer = document.getElementById('form-error-container');
        const closeErrorBtn = document.getElementById('close-error');

        const hideError = () => {
          errorContainer.classList.add('hidden');
          // After you render the error and show it:
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname,
          );
        };

        closeErrorBtn.addEventListener('click', hideError);
      });
    </script>
  </body>
</html>
