<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title><%= title %></title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="back-links">
        <a href="/dashboard" class="back-link">&larr; Back to Dashboard</a>
        <% if (categoryBackLink) { %>
        <a href="<%= categoryBackLink.url %>" class="back-link"
          >← <%= categoryBackLink.text %></a
        >
        <% } %>
      </div>

      <div id="form-error-container">
        <button
          id="close-error"
          class="btn-close hidden"
          aria-label="Close error"
        >
          &times;
        </button>
      </div>

      <!-- Top hero section: cover + main info -->
      <section class="book-hero">
        <div class="hero-cover">
          <img
            src="<%= book.cover_image_url || '/placeholder.png' %>"
            alt="Cover of <%= book.title %>"
            loading="lazy"
          />
        </div>

        <div class="hero-body">
          <div class="hero-top">
            <% const slug = (book.category_name ||
            '').toLowerCase().replace(/\s+/g, '-'); const known = ['read',
            'want-to-read', 'currently-reading', 'archive']; const pillClass =
            known.includes(slug) ? `status-${slug}` :
            `status-generic-${((book.category_id % 6) || 0) + 1}`; %>
            <span class="pill <%= pillClass %>"><%= book.category_name %></span>

            <% if (book.rating != null) { %>
            <span class="chip rating-chip hero-rating-chip">
              ★ <%= book.rating %>/10
            </span>
            <% } %>
          </div>

          <h1 class="book-title"><%= book.title %></h1>
          <h2 class="subtitle">by <%= book.author %></h2>

          <% if (book.genre) { %>
          <div class="chips hero-genres">
            <% book.genre.split(',').forEach((g) => { %>
            <span class="chip"><%= g.trim() %></span>
            <% }) %>
          </div>
          <% } %>

          <div class="hero-summary">
            <h3>Summary</h3>
            <p>
              <span style="white-space: pre-wrap"><%= book.summary || 'No summary yet.' %></span>
            </p>
          </div>

          <!-- Absolutely positioned actions in top-right -->
          <div class="action-buttons hero-actions">
            <a href="/books/<%= book.id %>/edit" class="btn btn-primary"
              >Edit</a
            >
            <button
              type="button"
              id="delete-book-button"
              class="btn btn-danger"
            >
              Delete
            </button>
          </div>
        </div>
      </section>

      <!-- Bottom centered stack: notes only (rating bar removed) -->
      <section class="book-bottom">
        <div class="section center-card">
          <h3>My Notes</h3>
          <p 
            <span style="white-space: pre-wrap"><%= book.review || 'No notes yet.' %></span>
          </p>
        </div>
      </section>
    </div>
    <form
      id="delete-modal"
      class="modal hidden"
      action="/books/<%= book.id %>/delete"
      method="POST"
    >
      <div class="modal-content">
        <h2>Confirm Delete</h2>
        <!-- Corrected the text to refer to "book" -->
        <p>Please enter the admin password to delete this book:</p>
        <input
          type="password"
          name="password"
          id="admin-password"
          placeholder="Admin password"
          required
        />
        <input
          type="hidden"
          name="redirectTo"
          value="<%= categoryBackLink ? categoryBackLink.url : '/dashboard' %>"
        />
        <div class="modal-actions">
          <button type="submit" class="btn btn-danger">Delete</button>
          <button type="button" id="cancel-delete" class="btn">Cancel</button>
        </div>
      </div>
    </form>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // --- Delete Modal Logic ---
        const deleteButton = document.getElementById('delete-book-button');
        const modal = document.getElementById('delete-modal');
        const cancelDelete = document.getElementById('cancel-delete');

        if (deleteButton && modal && cancelDelete) {
          deleteButton.addEventListener('click', () => {
            modal.classList.remove('hidden');
          });
          cancelDelete.addEventListener('click', () => {
            modal.classList.add('hidden');
          });
        }

        // --- Error Handling Logic ---
        const errorContainer = document.getElementById('form-error-container');
        const closeErrorBtn = document.getElementById('close-error');

        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');

        if (error) {
          // If an error is found in the URL, display it
          const errorList = document.createElement('ul');
          errorList.className = 'error-list';
          error.split(';').forEach((msg) => {
            const li = document.createElement('li');
            li.textContent = msg.trim();
            errorList.appendChild(li);
          });
          errorContainer.appendChild(errorList);
          closeErrorBtn.classList.remove('hidden');
        }

        if (closeErrorBtn) {
          closeErrorBtn.addEventListener('click', () => {
            // Hide the error container
            errorContainer.innerHTML = ''; // Clear the content
            closeErrorBtn.classList.add('hidden');
            // Clean the URL
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname,
            );
          });
        }
      });
    </script>
  </body>
</html>
